<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C++ Performance Study — Using CPU Cache Properties | Dr. Vladimir Petukhov</title>
    <meta name="description" content="A portfolio site as a general C++/Python programmer, general algorithms developer, industrial computer vision engineer, machine learning engineer and web apps developer.">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-6HX7S00F14"></script>
  <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-6HX7S00F14');</script>
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.3c7c2e09.css" as="style"><link rel="preload" href="/assets/js/app.180eebd7.js" as="script"><link rel="preload" href="/assets/js/5.91d9c5dd.js" as="script"><link rel="prefetch" href="/assets/js/10.9e246527.js"><link rel="prefetch" href="/assets/js/11.f093e171.js"><link rel="prefetch" href="/assets/js/12.e9b7f08a.js"><link rel="prefetch" href="/assets/js/13.fa47007a.js"><link rel="prefetch" href="/assets/js/14.60cf40c7.js"><link rel="prefetch" href="/assets/js/15.d2c3c64d.js"><link rel="prefetch" href="/assets/js/16.4a30f428.js"><link rel="prefetch" href="/assets/js/17.51aec36c.js"><link rel="prefetch" href="/assets/js/2.a873dd49.js"><link rel="prefetch" href="/assets/js/3.589839d9.js"><link rel="prefetch" href="/assets/js/4.f4ac6c29.js"><link rel="prefetch" href="/assets/js/6.0c9cba5d.js"><link rel="prefetch" href="/assets/js/7.5b9dc384.js"><link rel="prefetch" href="/assets/js/8.1b2dc3df.js"><link rel="prefetch" href="/assets/js/9.34bd3a85.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3c7c2e09.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Dr. Vladimir Petukhov</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Services/" class="nav-link">Services</a></div><div class="nav-item"><a href="/Contact/" class="nav-link">Contact Information</a></div><div class="nav-item"><a href="/Resume/" class="nav-link">CV</a></div><div class="nav-item"><a href="/Blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="https://github.com/vperepos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Services/" class="nav-link">Services</a></div><div class="nav-item"><a href="/Contact/" class="nav-link">Contact Information</a></div><div class="nav-item"><a href="/Resume/" class="nav-link">CV</a></div><div class="nav-item"><a href="/Blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="https://github.com/vperepos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>C++ Performance Study — Using CPU Cache Properties</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Blog/cpp-performance-cache-study.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Blog/cpp-performance-cache-study.html#code-structure-and-behaviour" class="sidebar-link">Code structure and behaviour</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Blog/cpp-performance-cache-study.html#results-and-discussion" class="sidebar-link">Results and discussion</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="c-performance-study-use-cpu-cache-properties"><a href="#c-performance-study-use-cpu-cache-properties" class="header-anchor">#</a> C++ Performance Study: Use CPU Cache Properties</h1> <p><a href="https://github.com/VPERepos/CppPerformanceStudy_UseCPUCacheProperties/tree/main" target="_blank" rel="noopener noreferrer">Code on Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>While learning how to work with images for computer vision, I was told to use a property of CPU cache in order to process two dimensional arrays in C++ faster. It means that accessing 2D arrays by rows in the inner loop is faster than by columns, due to the property of fast cache memory access, containing data lines. It is faster to get the whole line of data from the cache, than jumping from line to line. This small project compares 3 ways of containing 2D data in C++ (but the list is not complete only by these 3 types of data structures). The first considered data structure is a standard C++ dynamically allocated one dimensional array. The second is two dimensional C++ dynamically allocated array. And the last one is a vector of vectors from the standard C++ library.</p> <h2 id="code-structure-and-behaviour"><a href="#code-structure-and-behaviour" class="header-anchor">#</a> Code structure and behaviour</h2> <p>Another interesting programming feature that I wanted to show in this project is code duplication avoidance by utliziation of polymorph classes. The initial git commit here consists of proof of consept and one can see that code that measures the execution time is duplicated for every data structure. That is why I decided to refactor the code resulting in introduction of the following classes.
<img src="/assets/img/UseCacheClassDiagram.c650f995.svg" alt="UMLDiagram">
There is a parent class called Containers2d that has common functionality and variables and 3 specializing classes containing the described data structures. After refactoring the code that implements execution time measurements resides only in one place in the parent class. The functionality of the program is described by the following sequence diagram.
The containers are initialized randomly and the program measures execution time of accessing each element calculating squared value and saving it in the initial container. This is done 1000 times in order to measure average execution time.
<img src="/assets/img/UseCacheSequenceDiagram.f88d3bb3.svg" alt="UMLDiagram"></p> <h2 id="results-and-discussion"><a href="#results-and-discussion" class="header-anchor">#</a> Results and discussion</h2> <p>The results of several runs for different array sizes are presented in the file results.txt in the repository. Here some excerpt for an array 1000x1000 is presented in the table.</p> <table><thead><tr><th style="text-align:left"></th> <th style="text-align:left"></th> <th style="text-align:left"></th> <th style="text-align:left"></th></tr></thead> <tbody><tr><td style="text-align:left"><strong>Processing type</strong></td> <td style="text-align:left"><strong>Execution time (microseconds) Array1d</strong></td> <td style="text-align:left"><strong>Execution time (microseconds) Array2d</strong></td> <td style="text-align:left"><strong>Execution time (microseconds) Vector2d</strong></td></tr> <tr><td style="text-align:left">Processed by rows</td> <td style="text-align:left">2732.27</td> <td style="text-align:left">2622.73</td> <td style="text-align:left">7236.22</td></tr> <tr><td style="text-align:left">Processed by columns</td> <td style="text-align:left">3098.9</td> <td style="text-align:left">2879.58</td> <td style="text-align:left">7669.81</td></tr> <tr><td style="text-align:left">Ratio (%)</td> <td style="text-align:left">13</td> <td style="text-align:left">10</td> <td style="text-align:left">6</td></tr></tbody></table> <p>One can see that the slowest container is STL vector - around 3 times slower than the fastest one - dynamic 2D array. But the biggest performance increase has the 1D dynamic array. The results range a little bit from experiment to experiment, but the tendency remains the same. There are only several weird measurements braking the tendency, but recompilation of the project eliminated the behaviour, when STL vector processing by columns was a lot faster than by rows (please see the results.txt in the repository).</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.180eebd7.js" defer></script><script src="/assets/js/5.91d9c5dd.js" defer></script>
  </body>
</html>
